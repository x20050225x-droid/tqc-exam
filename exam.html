<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TQC ç¶²è·¯ç®¡ç†å¯¦å‹™ - æ™ºæ…§æ¸¬é©—ç³»çµ±</title>
    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; background-color: #f4f4f4; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); position: relative; }
        h1 { text-align: center; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        
        /* æ­¡è¿/é¸å–®ç•«é¢ */
        .menu-card { text-align: center; padding: 20px; }
        .mode-btn { display: block; width: 100%; max-width: 400px; margin: 15px auto; padding: 15px; font-size: 18px; border: none; border-radius: 8px; cursor: pointer; transition: 0.3s; text-align: left; position: relative; }
        .mode-btn div { font-size: 0.85em; opacity: 0.9; margin-top: 5px; font-weight: normal; }
        .mode-btn span { font-weight: bold; font-size: 1.1em; }

        .btn-normal { background-color: #28a745; color: white; }
        .btn-normal:hover { background-color: #218838; }
        
        .btn-weighted { background-color: #17a2b8; color: white; }
        .btn-weighted:hover { background-color: #138496; }

        .btn-weakness { background-color: #fd7e14; color: white; border-left: 8px solid #c9620b; }
        .btn-weakness:hover { background-color: #e36d0d; }

        .btn-reset { background-color: #6c757d; color: white; margin-top: 30px; font-size: 14px; padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; }

        /* è¨­å®šå€å¡Š */
        .settings-box { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; max-width: 400px; margin: 20px auto; text-align: left; }
        .settings-title { font-weight: bold; margin-bottom: 10px; color: #495057; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
        .radio-group label { display: inline-block; margin-right: 15px; cursor: pointer; }

        /* æ¸¬é©—å€ */
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .quit-btn { background: #dc3545; color: white; border: none; padding: 5px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9em; }
        .quit-btn:hover { background: #c82333; }

        .question-card { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px; background-color: #fafafa; }
        .question-title { font-size: 1.2em; font-weight: bold; margin-bottom: 15px; color: #2c3e50; }
        
        /* é¸é …æ¨£å¼ */
        .options label { display: block; margin: 8px 0; cursor: pointer; padding: 12px; border-radius: 5px; border: 1px solid #eee; background: white; transition: 0.2s; position: relative; }
        .options label:hover { background-color: #e9ecef; border-color: #adb5bd; }
        /* è¢«é¸ä¸­çš„æ¨£å¼ */
        .options input:checked + span { font-weight: bold; color: #0056b3; }
        /* é–å®šå¾Œçš„æ¨£å¼ */
        .options input:disabled + span { color: #666; }

        /* æŒ‰éˆ•å€ */
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 15px; }
        .btn { background-color: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 16px; flex: 1; margin: 0 5px; }
        .btn:hover { background-color: #0056b3; }
        
        .btn-prev { background-color: #6c757d; max-width: 120px; }
        .btn-prev:hover { background-color: #5a6268; }
        
        /* çµæœè¨Šæ¯ */
        .result-msg { margin-top: 10px; font-weight: bold; padding: 10px; border-radius: 5px; text-align: center; }
        .correct { background-color: #d4edda; color: #155724; }
        .wrong { background-color: #f8d7da; color: #721c24; }
        
        /* éŒ¯é¡Œåˆ†æå€ */
        .analysis-item { border-left: 5px solid #dc3545; background: #fff5f5; padding: 15px; margin-bottom: 15px; border-radius: 4px; text-align: left; }
        .analysis-q { font-weight: bold; color: #333; }
        .weight-badge { background: #ffc107; color: #333; padding: 2px 6px; border-radius: 10px; font-size: 0.8em; margin-left: 5px; }

        .hidden { display: none; }
        .invisible { visibility: hidden; } /* ä½”ä½ä½†ä¸é¡¯ç¤º */
    </style>
</head>
<body>

<div class="container">
    <h1>ç¶²è·¯ç®¡ç†å¯¦å‹™ - æ™ºæ…§æ¸¬é©—ç³»çµ±</h1>

    <div id="start-screen" class="menu-card">
        
        <div class="settings-box">
            <div class="settings-title">âš™ï¸ ä½œç­”è¨­å®š</div>
            <div class="radio-group">
                <label>
                    <input type="radio" name="submitMode" value="confirm" checked> ç¢ºèªå¾Œé€å‡º (æª¢æŸ¥ç”¨)
                </label>
                <label>
                    <input type="radio" name="submitMode" value="instant"> é»æ“Šå³é€å‡º (ç§’æ®ºç”¨)
                </label>
            </div>
            <div style="margin-top: 10px; font-size: 0.85em; color: #666;">
                * ç­”é¡Œå¾Œå°‡è‡ªå‹•åœç•™ 1 ç§’ä¸¦è·³è½‰ä¸‹ä¸€é¡Œ
            </div>
        </div>

        <button class="mode-btn btn-normal" onclick="startExam('normal')">
            <span>ğŸ² éš¨æ©Ÿæ¸¬é©— (40é¡Œ)</span>
            <div>å…¨é¡Œåº«éš¨æ©ŸæŠ½é¸ï¼Œé©åˆæ—¥å¸¸ç·´ç¿’</div>
        </button>
        
        <button class="mode-btn btn-weighted" onclick="startExam('weighted')">
            <span>âš–ï¸ åŠ æ¬Šéš¨æ©Ÿ (40é¡Œ)</span>
            <div>å¸¸éŒ¯é¡Œç›®å‡ºç¾æ©Ÿç‡è¼ƒé«˜ï¼Œå…¼é¡§è¤‡ç¿’èˆ‡æ–°é¡Œ</div>
        </button>

        <button class="mode-btn btn-weakness" onclick="startExam('top20')">
            <span>ğŸ”¥ éŒ¯é¡Œç‰¹è¨“ (Top 20)</span>
            <div>ç›´æ¥é–å®šéŒ¯èª¤æ¬Šé‡æœ€é«˜çš„ 20 é¡Œé€²è¡Œç‰¹è¨“</div>
        </button>

        <div style="margin-top: 20px; font-size: 0.9em; color: #666;">
            éŒ¯é¡Œæ¬Šé‡è³‡æ–™åº«ï¼š<span id="stored-count">0</span> ç­†
        </div>
        
        <button class="mode-btn btn-reset" onclick="resetWeights()">é‡ç½®æ‰€æœ‰ç´€éŒ„</button>
    </div>
    
    <div id="quiz-area" class="hidden">
        <div class="header-bar">
            <div>
                <span id="current-mode-text" style="color: #007bff; font-weight: bold;"></span> | 
                é€²åº¦: <span id="current-q">1</span> / <span id="total-exam-q">40</span>
            </div>
            <button class="quit-btn" onclick="quitExam()">â†© è¿”å›é¸å–®</button>
        </div>
        
        <div id="question-container">
            </div>

        <div class="nav-buttons">
            <button id="prev-btn" class="btn btn-prev hidden" onclick="prevQuestion()">â¬… ä¸Šä¸€é¡Œ</button>
            <button id="submit-btn" class="btn" onclick="checkAnswer()">é€å‡ºç­”æ¡ˆ</button>
            <button id="next-btn" class="btn hidden" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ â¡</button>
        </div>
    </div>

    <div id="final-result" class="hidden">
        <div style="text-align: center; margin-bottom: 30px;">
            <h2>æ¸¬é©—çµæŸ</h2>
            <div style="font-size: 1.5em; color: #555;">ç­”å°é¡Œæ•¸ï¼š<span id="correct-count"></span> / <span id="total-count"></span></div>
            <div style="font-size: 2.5em; font-weight: bold; color: #007bff; margin-top: 10px;">
                ç¸½åˆ†ï¼š<span id="final-score"></span>
            </div>
            <p style="font-size: 0.9em; color: #888;">(æ¯é¡Œ2.5åˆ†)</p>
        </div>

        <div id="wrong-answer-analysis">
            <h3 style="border-bottom: 2px solid #ddd; padding-bottom: 10px;">æœ¬æ¬¡éŒ¯é¡Œåˆ—è¡¨</h3>
            <div id="analysis-list">
                </div>
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <button class="btn" onclick="goHome()">è¿”å›ä¸»é¸å–®</button>
        </div>
    </div>
</div>

<script src="questions.js"></script>

<script>
    // --- å…¨åŸŸè®Šæ•¸ ---
    const QUESTIONS_PER_EXAM = 40; 
    let examQuestions = []; 
    let currentQuestionIndex = 0;
    let correctCount = 0; // ç­”å°é¡Œæ•¸
    let userWrongAnswers = []; 
    let submitMode = 'confirm';
    
    // ç”¨ä¾†å„²å­˜æ¯ä¸€é¡Œçš„ä½œç­”ç‹€æ…‹ï¼Œå¯¦ç¾ã€Œè¿”å›ä¸Šä¸€é¡Œã€åŠŸèƒ½
    // æ ¼å¼: { index: { userAns: [], isCorrect: bool, checked: bool } }
    let answerHistory = {}; 

    // --- åˆå§‹åŒ–èˆ‡å·¥å…·å‡½æ•¸ ---
    function getStoredWeights() {
        const stored = localStorage.getItem('tqc_exam_weights');
        return stored ? JSON.parse(stored) : {};
    }

    function saveStoredWeights(weights) {
        localStorage.setItem('tqc_exam_weights', JSON.stringify(weights));
        updateUIStats();
    }

    function updateUIStats() {
        const weights = getStoredWeights();
        const count = Object.keys(weights).length;
        let weightedCount = 0;
        for(let k in weights) { if(weights[k] > 1) weightedCount++; }
        
        const displayEl = document.getElementById('stored-count');
        if(displayEl) displayEl.innerText = weightedCount > 0 ? `${count} (å…¶ä¸­ ${weightedCount} é¡Œæœ‰åŠ æ¬Š)` : '0';
    }
    
    updateUIStats();

    // --- æ ¸å¿ƒåŠŸèƒ½: é–‹å§‹æ¸¬é©— ---
    function startExam(mode) {
        if (typeof questions === 'undefined') {
            alert("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ° questions.jsã€‚");
            return;
        }

        const radioInstant = document.querySelector('input[name="submitMode"][value="instant"]');
        submitMode = radioInstant.checked ? 'instant' : 'confirm';

        correctCount = 0;
        currentQuestionIndex = 0;
        userWrongAnswers = [];
        answerHistory = {}; // é‡ç½®æ­·å²ç´€éŒ„
        
        let pool = JSON.parse(JSON.stringify(questions));
        const weights = getStoredWeights();

        // --- é¸é¡Œé‚è¼¯ ---
        if (mode === 'top20') {
            let wrongPool = pool.filter(q => (weights[q.id] || 1) > 1);
            if (wrongPool.length === 0) {
                alert("ç›®å‰æ²’æœ‰éŒ¯é¡Œç´€éŒ„ï¼Œåˆ‡æ›ç‚ºéš¨æ©Ÿæ¨¡å¼ã€‚");
                startExam('normal');
                return;
            }
            wrongPool.sort((a, b) => (weights[b.id] || 1) - (weights[a.id] || 1));
            examQuestions = wrongPool.slice(0, 20);
        } else if (mode === 'weighted') {
            examQuestions = [];
            const targetCount = Math.min(QUESTIONS_PER_EXAM, pool.length);
            for (let i = 0; i < targetCount; i++) {
                let totalWeight = 0;
                pool.forEach(q => {
                    let w = weights[q.id] || 1; 
                    q._tempWeight = w;
                    totalWeight += w;
                });
                let randomVal = Math.random() * totalWeight;
                let selectedIndex = -1;
                for (let j = 0; j < pool.length; j++) {
                    randomVal -= pool[j]._tempWeight;
                    if (randomVal <= 0) { selectedIndex = j; break; }
                }
                if (selectedIndex === -1) selectedIndex = pool.length - 1;
                examQuestions.push(pool[selectedIndex]);
                pool.splice(selectedIndex, 1);
            }
        } else {
            for (let i = pool.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [pool[i], pool[j]] = [pool[j], pool[i]];
            }
            examQuestions = pool.slice(0, QUESTIONS_PER_EXAM);
        }

        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('quiz-area').classList.remove('hidden');
        
        let modeName = (mode === 'weighted') ? "åŠ æ¬Š" : (mode === 'top20' ? "éŒ¯é¡Œç‰¹è¨“" : "ä¸€èˆ¬");
        document.getElementById('current-mode-text').innerText = modeName;
        document.getElementById('total-exam-q').innerText = examQuestions.length;
        
        renderQuestion();
    }

    // --- æ¸²æŸ“é¡Œç›® ---
    function renderQuestion() {
        const q = examQuestions[currentQuestionIndex];
        const container = document.getElementById('question-container');
        document.getElementById('current-q').innerText = currentQuestionIndex + 1;
        
        // æª¢æŸ¥é€™ä¸€é¡Œæ˜¯å¦å·²ç¶“ä½œç­”é
        const history = answerHistory[currentQuestionIndex];
        const isReviewed = (history && history.checked); // æ˜¯å¦å·²ä½œç­”ä¸¦æª¢æŸ¥é

        const weights = getStoredWeights();
        const currentWeight = weights[q.id] || 1;
        
        let inputType = q.type; 
        let optionsHtml = '';
        const keys = Object.keys(q.options).sort(); 
        
        const isInstant = (submitMode === 'instant' && inputType === 'radio' && !isReviewed);

        keys.forEach(key => {
            // ç‹€æ…‹åˆ¤æ–·
            let checkedAttr = '';
            let disabledAttr = '';
            let clickAction = isInstant ? `onclick="checkAnswer()"` : '';

            // å¦‚æœå·²ç¶“ä½œç­”éï¼Œé‚„åŸé¸æ“‡ç‹€æ…‹ä¸¦é–å®š
            if (isReviewed) {
                if (history.userAns.includes(key)) {
                    checkedAttr = 'checked';
                }
                disabledAttr = 'disabled';
                clickAction = ''; // ç§»é™¤é»æ“Šäº‹ä»¶
            }

            optionsHtml += `
                <label>
                    <input type="${inputType}" name="option" value="${key}" ${clickAction} ${checkedAttr} ${disabledAttr}>
                    <span>(${key})</span> ${q.options[key]}
                </label>
            `;
        });

        let badgeHtml = currentWeight > 1 ? `<span class="weight-badge">æ¬Šé‡: ${currentWeight}</span>` : '';

        container.innerHTML = `
            <div class="question-card">
                <div class="question-title">
                    ${q.id}. ${q.text} ${badgeHtml}
                </div>
                <div class="options">
                    ${optionsHtml}
                </div>
                <div id="result-msg" class="result-msg hidden"></div>
            </div>
        `;

        // å¦‚æœæ˜¯å›é ­æŸ¥çœ‹å·²ä½œç­”çš„é¡Œç›®ï¼Œé¡¯ç¤ºçµæœè¨Šæ¯
        if (isReviewed) {
            showResultUI(history.isCorrect, q.answer);
            document.getElementById('submit-btn').classList.add('hidden');
            // å¦‚æœæ˜¯æœ€å¾Œä¸€é¡Œï¼Œé¡¯ç¤ºçµç®—ï¼›å¦å‰‡é¡¯ç¤ºä¸‹ä¸€é¡Œ
            if (currentQuestionIndex < examQuestions.length - 1) {
                document.getElementById('next-btn').classList.remove('hidden');
            } else {
                 // æœ€å¾Œä¸€é¡Œ Review ç‹€æ…‹ä¸‹ï¼Œä¸é¡¯ç¤º Nextï¼Œä½¿ç”¨è€…å¯ä»¥é»é¸ä¸Šä¸€é¡Œæˆ–ç›´æ¥çµæŸ(éœ€å¢åŠ çµæŸæŒ‰éˆ•? ä¸ï¼Œé€šå¸¸è‡ªå‹•è·³è½‰äº†)
                 // é€™è£¡æˆ‘å€‘å¯ä»¥è£œä¸€å€‹ã€ŒæŸ¥çœ‹æˆç¸¾ã€æŒ‰éˆ•åœ¨ Next çš„ä½ç½®
                 const nextBtn = document.getElementById('next-btn');
                 nextBtn.innerText = "æŸ¥çœ‹æˆç¸¾";
                 nextBtn.onclick = showFinalResult;
                 nextBtn.classList.remove('hidden');
            }
        } else {
            // å°šæœªä½œç­”
            const submitBtn = document.getElementById('submit-btn');
            if (isInstant) {
                submitBtn.classList.add('hidden');
            } else {
                submitBtn.classList.remove('hidden');
            }
            document.getElementById('next-btn').classList.add('hidden');
        }

        // ä¸Šä¸€é¡ŒæŒ‰éˆ•æ§åˆ¶
        const prevBtn = document.getElementById('prev-btn');
        if (currentQuestionIndex > 0) {
            prevBtn.classList.remove('hidden');
        } else {
            prevBtn.classList.add('hidden');
        }
    }

    // --- æª¢æŸ¥ç­”æ¡ˆ ---
    function checkAnswer() {
        const q = examQuestions[currentQuestionIndex];
        const selectedEls = document.querySelectorAll('input[name="option"]:checked');
        
        // å¦‚æœå·²ç¶“é–å®š(å·²ä½œç­”)ï¼Œä¸è™•ç†
        if (answerHistory[currentQuestionIndex] && answerHistory[currentQuestionIndex].checked) return;

        let userAns = [];
        selectedEls.forEach(el => userAns.push(el.value));
        userAns.sort();

        if (userAns.length === 0) {
            if (submitMode !== 'instant') alert("è«‹å…ˆé¸æ“‡ç­”æ¡ˆï¼");
            return;
        }

        const isCorrect = JSON.stringify(userAns) === JSON.stringify(q.answer);
        
        // å„²å­˜æ¬Šé‡èˆ‡çµ±è¨ˆ
        updateQuestionWeight(q.id, isCorrect);
        if (isCorrect) correctCount++;
        
        // è¨˜éŒ„æ­¤é¡Œç‹€æ…‹
        answerHistory[currentQuestionIndex] = {
            userAns: userAns,
            isCorrect: isCorrect,
            checked: true
        };

        if (!isCorrect) {
            userWrongAnswers.push({
                question: q,
                userAns: userAns,
                correctAns: q.answer
            });
        }

        // é¡¯ç¤º UI çµæœ
        showResultUI(isCorrect, q.answer);
        
        // é–å®šé¸é …
        const allInputs = document.querySelectorAll('input[name="option"]');
        allInputs.forEach(input => input.disabled = true);

        // éš±è—é€å‡ºæŒ‰éˆ•
        document.getElementById('submit-btn').classList.add('hidden');

        // *** è‡ªå‹•è·³è½‰é‚è¼¯ ***
        // å»¶é² 1 ç§’å¾Œè‡ªå‹•ä¸‹ä¸€é¡Œ
        setTimeout(() => {
            // åªæœ‰ç•¶ä½¿ç”¨è€…é‚„åœç•™åœ¨ç•¶å‰é€™é¡Œæ™‚æ‰è·³è½‰ (é¿å…ä½¿ç”¨è€…é€™1ç§’å…§æŒ‰äº†ä¸Šä¸€é¡Œ)
            // ä¸¦ä¸”ä¸æ˜¯æœ€å¾Œä¸€é¡Œ
            if (currentQuestionIndex < examQuestions.length - 1) {
                nextQuestion();
            } else {
                // å¦‚æœæ˜¯æœ€å¾Œä¸€é¡Œï¼Œé¡¯ç¤ºçµç®—
                showFinalResult();
            }
        }, 500); 
    }

    // é¡¯ç¤ºçµæœæ¢ (ç¶ è‰²/ç´…è‰²æ¡†)
    function showResultUI(isCorrect, correctAns) {
        const resultMsg = document.getElementById('result-msg');
        resultMsg.classList.remove('hidden');
        if (isCorrect) {
            resultMsg.innerHTML = "ğŸ‰ ç­”å°äº†ï¼";
            resultMsg.className = "result-msg correct";
        } else {
            resultMsg.innerHTML = `âŒ ç­”éŒ¯äº†ï¼æ­£ç¢ºç­”æ¡ˆï¼š${correctAns.join('')}`;
            resultMsg.className = "result-msg wrong";
        }
    }

    function updateQuestionWeight(questionId, isCorrect) {
        let weights = getStoredWeights();
        let currentW = weights[questionId] || 1;
        if (isCorrect) {
            currentW = Math.max(1, currentW - 1);
        } else {
            currentW = currentW + 1;
        }
        weights[questionId] = currentW;
        saveStoredWeights(weights);
    }

    function prevQuestion() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            renderQuestion();
        }
    }

    function nextQuestion() {
        if (currentQuestionIndex < examQuestions.length - 1) {
            currentQuestionIndex++;
            renderQuestion();
        } else {
            showFinalResult();
        }
    }

    function quitExam() {
        if(confirm("æ¸¬é©—å°šæœªçµæŸï¼Œç¢ºå®šè¦è¿”å›é¸å–®å—ï¼Ÿ")) {
            goHome();
        }
    }

    function goHome() {
        document.getElementById('quiz-area').classList.add('hidden');
        document.getElementById('final-result').classList.add('hidden');
        document.getElementById('start-screen').classList.remove('hidden');
        updateUIStats();
    }

    function showFinalResult() {
        document.getElementById('quiz-area').classList.add('hidden');
        document.getElementById('final-result').classList.remove('hidden');
        
        // 2.5åˆ†è¨ˆç®—
        let finalScore = correctCount *2.5;
        
        document.getElementById('correct-count').innerText = correctCount;
        document.getElementById('total-count').innerText = examQuestions.length;
        document.getElementById('final-score').innerText = finalScore;

        const analysisList = document.getElementById('analysis-list');
        analysisList.innerHTML = ""; 

        if (userWrongAnswers.length === 0) {
            analysisList.innerHTML = "<div style='text-align:center; color:#28a745; padding:20px;'>âœ¨ å®Œç¾ï¼æœ¬æ¬¡æ²’æœ‰ç­”éŒ¯ä»»ä½•é¡Œç›®ï¼</div>";
        } else {
            const weights = getStoredWeights();
            userWrongAnswers.forEach((item, idx) => {
                const q = item.question;
                const newWeight = weights[q.id] || 1;
                analysisList.innerHTML += `
                    <div class="analysis-item">
                        <div class="analysis-q">
                            ${idx + 1}. [${q.id}] ${q.text} 
                            <span class="weight-badge">æ¬Šé‡: ${newWeight}</span>
                        </div>
                        <div style="margin-top:5px; color:#666;">
                            ä½ çš„ç­”æ¡ˆ: <b style="color:#dc3545">${item.userAns.join('')}</b> â” 
                            æ­£ç¢ºç­”æ¡ˆ: <b style="color:#28a745">${item.correctAns.join('')}</b>
                        </div>
                    </div>
                `;
            });
        }
    }

    function resetWeights() {
        if(confirm("ç¢ºå®šè¦åˆªé™¤æ‰€æœ‰éŒ¯é¡Œæ¬Šé‡ç´€éŒ„å—ï¼Ÿ")) {
            localStorage.removeItem('tqc_exam_weights');
            updateUIStats();
            alert("å·²é‡ç½®å®Œç•¢ï¼");
        }
    }
</script>

</body>

</html>


