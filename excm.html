<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TQC ç¶²è·¯ç®¡ç†å¯¦å‹™ - æ™ºæ…§å‚™è€ƒç³»çµ±</title>
    <style>
        body { font-family: "Microsoft JhengHei", "Segoe UI", Arial, sans-serif; background-color: #e9ecef; margin: 0; padding: 20px; color: #333; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 25px; font-size: 1.8em; }
        
        /* é€²åº¦æ¢å€åŸŸ */
        .progress-section { margin-bottom: 30px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6; }
        .progress-label { display: flex; justify-content: space-between; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        .progress-bar-bg { background: #e9ecef; height: 20px; border-radius: 10px; overflow: hidden; }
        .progress-bar-fill { background: linear-gradient(90deg, #28a745, #20c997); height: 100%; width: 0%; transition: width 0.5s ease; text-align: center; color: white; font-size: 12px; line-height: 20px; }

        /* éšæ®µæŒ‰éˆ•æ¨£å¼ */
        .stage-card { border: 2px solid transparent; border-radius: 10px; margin-bottom: 20px; transition: 0.2s; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.05); overflow: hidden; }
        .stage-card:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .stage-btn { width: 100%; border: none; background: none; text-align: left; padding: 0; cursor: pointer; display: flex; align-items: stretch; }
        .stage-icon { width: 60px; display: flex; align-items: center; justify-content: center; font-size: 1.5em; color: white; flex-shrink: 0; }
        .stage-content { padding: 15px; flex-grow: 1; }
        .stage-title { font-weight: bold; font-size: 1.1em; display: block; margin-bottom: 4px; }
        .stage-desc { font-size: 0.85em; color: #666; font-weight: normal; }
        .stage-badge { display: inline-block; font-size: 0.75em; padding: 2px 8px; border-radius: 10px; background: #eee; color: #555; margin-top: 5px; }

        /* éšæ®µé¡è‰²å®šç¾© */
        .s1 .stage-icon { background-color: #007bff; }
        .s1.stage-card { border-color: #b8daff; }
        
        .s2 .stage-icon { background-color: #fd7e14; }
        .s2.stage-card { border-color: #ffeeba; }
        
        .s3 .stage-icon { background-color: #6f42c1; }
        .s3.stage-card { border-color: #d6d8db; }

        .disabled-card { opacity: 0.6; filter: grayscale(1); pointer-events: none; }

        /* è¨­å®šå€å¡Š */
        .settings-box { background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; padding: 10px 15px; margin-bottom: 20px; text-align: right; font-size: 0.9em; display: flex; justify-content: space-between; align-items: center; }
        .btn-reset { background: transparent; color: #dc3545; border: 1px solid #dc3545; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8em; }
        .btn-reset:hover { background: #dc3545; color: white; }

        /* æ¸¬é©—å€ (ä¿æŒåŸæ¨£ï¼Œå¾®èª¿) */
        .header-bar { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px; }
        .quit-btn { background: #6c757d; color: white; border: none; padding: 6px 15px; border-radius: 20px; cursor: pointer; font-size: 0.9em; }
        
        .question-card { border: 1px solid #dee2e6; padding: 20px; margin-bottom: 20px; border-radius: 8px; background-color: #fafafa; }
        .question-title { font-size: 1.25em; font-weight: 600; margin-bottom: 20px; color: #212529; line-height: 1.4; }
        
        .options label { display: block; margin: 10px 0; cursor: pointer; padding: 15px; border-radius: 8px; border: 2px solid #e9ecef; background: white; transition: 0.2s; position: relative; }
        .options label:hover { border-color: #adb5bd; background-color: #f1f3f5; }
        .options input:checked + span { font-weight: bold; color: #0056b3; }
        
        /* çµæœæ¨£å¼ */
        .result-msg { margin-top: 15px; font-weight: bold; padding: 12px; border-radius: 6px; text-align: center; }
        .correct { background-color: #d1e7dd; color: #0f5132; border: 1px solid #badbcc; }
        .wrong { background-color: #f8d7da; color: #842029; border: 1px solid #f5c2c7; }

        /* æŒ‰éˆ•å€ */
        .nav-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .btn { background-color: #0d6efd; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-size: 16px; flex: 1; font-weight: bold; transition: 0.2s; }
        .btn:hover { background-color: #0b5ed7; }
        .btn-prev { background-color: #6c757d; flex: 0 0 100px; }
        .btn-prev:hover { background-color: #5c636a; }

        .hidden { display: none !important; }
        
        /* éŒ¯é¡Œåˆ†æåˆ—è¡¨ */
        .analysis-item { border-left: 4px solid #dc3545; background: #fff; padding: 15px; margin-bottom: 10px; border-radius: 4px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .tag-new { background: #17a2b8; color: white; font-size: 0.7em; padding: 2px 5px; border-radius: 4px; vertical-align: middle; margin-right: 5px; }
    </style>
</head>
<body>

<div class="container">
    <div id="start-screen">
        <h1>ç¶²è·¯ç®¡ç†å¯¦å‹™ - æ™ºæ…§å‚™è€ƒç³»çµ±</h1>

        <div class="progress-section">
            <div class="progress-label">
                <span>ç¬¬ä¸€éè¦†è“‹ç‡ (æœªåšé¡Œé€²åº¦)</span>
                <span id="coverage-text">0%</span>
            </div>
            <div class="progress-bar-bg">
                <div id="progress-bar" class="progress-bar-fill"></div>
            </div>
            <div style="text-align: right; margin-top: 5px; font-size: 0.85em; color: #666;">
                å·²åš: <span id="done-count">0</span> / ç¸½é¡Œæ•¸: <span id="total-pool-count">0</span> | éŒ¯é¡Œåº«: <span id="wrong-count">0</span>
            </div>
        </div>

        <div class="settings-box">
            <div>
                <label style="margin-right:15px; cursor:pointer;"><input type="radio" name="submitMode" value="confirm" checked> ç¢ºèªå¾Œé€å‡º</label>
                <label style="cursor:pointer;"><input type="radio" name="submitMode" value="instant"> é»æ“Šå³é€å‡º</label>
            </div>
            <button class="btn-reset" onclick="resetAllData()">âš ï¸ é‡ç½®æ‰€æœ‰é€²åº¦</button>
        </div>

        <div class="stage-card s1">
            <button class="stage-btn" onclick="startExam('unanswered')">
                <div class="stage-icon">1</div>
                <div class="stage-content">
                    <span class="stage-title">ç¬¬ä¸€éšæ®µï¼šæ¶ˆæ»…æœªåšé¡Œ</span>
                    <span class="stage-desc">å„ªå…ˆç·´ç¿’å¾æœªåšéçš„é¡Œç›®ã€‚ç›®æ¨™æ˜¯å°‡è¦†è“‹ç‡æ¨åˆ° 100%ã€‚</span>
                    <div><span class="stage-badge" id="badge-new-count">å‰©é¤˜ 0 é¡Œ</span></div>
                </div>
            </button>
        </div>

        <div class="stage-card s2">
            <button class="stage-btn" onclick="startExam('review_wrong')">
                <div class="stage-icon">2</div>
                <div class="stage-content">
                    <span class="stage-title">ç¬¬äºŒéšæ®µï¼šéŒ¯é¡Œå¤§æƒé™¤</span>
                    <span class="stage-desc">å°ˆæ”»æ­·å²éŒ¯é¡Œã€‚ç­”å°å¾Œæ¬Šé‡æœƒä¸‹é™ï¼Œç›´åˆ°å®Œå…¨æŒæ¡ã€‚</span>
                    <div><span class="stage-badge" id="badge-wrong-count">å¾…è¤‡ç¿’ 0 é¡Œ</span></div>
                </div>
            </button>
        </div>

        <div class="stage-card s3">
            <button class="stage-btn" onclick="startExam('normal')">
                <div class="stage-icon">3</div>
                <div class="stage-content">
                    <span class="stage-title">ç¬¬ä¸‰éšæ®µï¼šå…¨çœŸæ¨¡æ“¬ (40é¡Œ)</span>
                    <span class="stage-desc">å®Œå…¨éš¨æ©ŸæŠ½é¸ã€‚è€ƒå‰ 3 å¤©è¡åˆºç”¨ï¼Œæ¨¡æ“¬çœŸå¯¦è€ƒè©¦æ‰‹æ„Ÿã€‚</span>
                </div>
            </button>
        </div>
    </div>
    
    <div id="quiz-area" class="hidden">
        <div class="header-bar">
            <div>
                <span id="current-mode-tag" style="background:#007bff; color:white; padding:2px 8px; border-radius:4px; font-size:0.8em; margin-right:10px;">æ¨¡å¼</span>
                <span style="font-weight:bold; color:#555;">ç¬¬ <span id="current-q">1</span> / <span id="total-exam-q">40</span> é¡Œ</span>
            </div>
            <button class="quit-btn" onclick="quitExam()">æš«åœ/è¿”å›</button>
        </div>
        
        <div id="question-container"></div>

        <div class="nav-buttons">
            <button id="prev-btn" class="btn btn-prev hidden" onclick="prevQuestion()">ä¸Šé¡Œ</button>
            <button id="submit-btn" class="btn" onclick="checkAnswer()">ç¢ºå®šé€å‡º</button>
            <button id="next-btn" class="btn hidden" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ â¡</button>
        </div>
    </div>

    <div id="final-result" class="hidden">
        <div style="text-align: center; margin-bottom: 30px;">
            <h2 style="color:#2c3e50;">æ¸¬é©—å®Œæˆ</h2>
            <div style="font-size: 3em; font-weight: bold; color: #0d6efd; margin: 10px 0;">
                <span id="final-score">0</span> <span style="font-size:0.4em; color:#999;">åˆ†</span>
            </div>
            <p>ç­”å°: <span id="correct-count">0</span> / <span id="total-count">0</span></p>
        </div>

        <div id="wrong-answer-analysis">
            <h3 style="border-bottom: 2px solid #eee; padding-bottom: 10px;">éŒ¯é¡Œæª¢è¨</h3>
            <div id="analysis-list"></div>
        </div>

        <div style="text-align: center; margin-top: 30px;">
            <button class="btn" onclick="goHome()">è¿”å›é¦–é æ›´æ–°é€²åº¦</button>
        </div>
    </div>
</div>

<script src="questions.js"></script>

<script>
    // --- æ ¸å¿ƒè®Šæ•¸ ---
    const QUESTIONS_PER_EXAM = 40; 
    let examQuestions = []; 
    let currentQuestionIndex = 0;
    let correctCount = 0;
    let userWrongAnswers = []; 
    let answerHistory = {}; // æ¯ä¸€é¡Œçš„ç•¶ä¸‹ä½œç­”ç´€éŒ„ {index: {userAns, isCorrect...}}
    let submitMode = 'confirm';

    // --- åˆå§‹åŒ– ---
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof questions === 'undefined') {
            alert("æ‰¾ä¸åˆ° questions.jsï¼Œè«‹ç¢ºä¿æª”æ¡ˆåœ¨åŒä¸€ç›®éŒ„ä¸‹ã€‚");
            return;
        }
        updateDashboard();
    });

    // --- è³‡æ–™å­˜å–å±¤ (LocalStorage) ---
    function getStoredData() {
        const defaultData = {
            weights: {}, // { id: weight } 1=normal, >1=wrong often
            answeredIds: [] // [id1, id2...] List of IDs ever answered
        };
        const stored = localStorage.getItem('tqc_smart_data');
        if (!stored) return defaultData;
        
        // ç°¡å–®çš„åˆä½µé˜²æ­¢èˆŠè³‡æ–™çµæ§‹ç¼ºå°‘æ¬„ä½
        let data = JSON.parse(stored);
        if(!data.answeredIds) data.answeredIds = [];
        return data;
    }

    function saveData(data) {
        localStorage.setItem('tqc_smart_data', JSON.stringify(data));
        updateDashboard();
    }

    // --- å„€è¡¨æ¿èˆ‡é‚è¼¯ ---
    function updateDashboard() {
        if (typeof questions === 'undefined') return;
        
        const data = getStoredData();
        const totalQ = questions.length;
        const doneCount = new Set(data.answeredIds).size; // ä½¿ç”¨ Set å»é‡ç¢ºä¿æº–ç¢º
        const wrongCount = Object.values(data.weights).filter(w => w > 1).length;

        // æ›´æ–°é€²åº¦æ¢
        const percentage = Math.round((doneCount / totalQ) * 100);
        document.getElementById('progress-bar').style.width = percentage + '%';
        document.getElementById('progress-bar').innerText = percentage + '%';
        document.getElementById('coverage-text').innerText = percentage + '%';
        
        document.getElementById('done-count').innerText = doneCount;
        document.getElementById('total-pool-count').innerText = totalQ;
        document.getElementById('wrong-count').innerText = wrongCount;

        // æ›´æ–°æŒ‰éˆ•ä¸Šçš„å¾½ç« è³‡è¨Š
        const remainingNew = totalQ - doneCount;
        document.getElementById('badge-new-count').innerText = remainingNew > 0 ? `å‰©é¤˜ ${remainingNew} é¡Œ` : "å·²å®Œæˆæ‰€æœ‰é¡Œç›®ï¼";
        document.getElementById('badge-wrong-count').innerText = `å¾…è¤‡ç¿’ ${wrongCount} é¡Œ`;

        // è¦–è¦ºå›é¥‹ï¼šå¦‚æœå…¨åšå®Œäº†ï¼Œç¬¬ä¸€éšæ®µè®Šç¶ è‰²å‹¾å‹¾æ„Ÿ(é€™è£¡ç°¡å–®è™•ç†æ–‡å­—)
        if(remainingNew === 0) {
            document.querySelector('.s1 .stage-icon').innerHTML = 'âœ“';
            document.querySelector('.s1 .stage-icon').style.background = '#28a745';
        }
    }

    // --- é–‹å§‹æ¸¬é©—é‚è¼¯ ---
    function startExam(mode) {
        const data = getStoredData();
        const answeredSet = new Set(data.answeredIds);
        let pool = JSON.parse(JSON.stringify(questions)); // Deep copy
        let selectedQuestions = [];
        let modeTitle = "";

        // è®€å–è¨­å®š
        const radioInstant = document.querySelector('input[name="submitMode"][value="instant"]');
        submitMode = radioInstant.checked ? 'instant' : 'confirm';

        if (mode === 'unanswered') {
            // é‚è¼¯ï¼šåªé¸ ID ä¸åœ¨ answeredSet è£¡é¢çš„
            let newPool = pool.filter(q => !answeredSet.has(q.id));
            if (newPool.length === 0) {
                alert("æ­å–œï¼æ‚¨å·²ç¶“åšéé¡Œåº«ä¸­çš„æ‰€æœ‰é¡Œç›®äº†ã€‚\nå»ºè­°é€²å…¥ã€Œç¬¬äºŒéšæ®µï¼šéŒ¯é¡Œå¤§æƒé™¤ã€æˆ–ã€Œç¬¬ä¸‰éšæ®µï¼šå…¨çœŸæ¨¡æ“¬ã€ã€‚");
                return;
            }
            // å¦‚æœå‰©é¤˜é¡Œç›®å°‘æ–¼ 40ï¼Œå°±å…¨å‡ºï¼›å¦å‰‡éš¨æ©Ÿé¸ 40 (æˆ–æŒ‰é †åºé¸? éš¨æ©Ÿæ¯”è¼ƒå¥½)
            shuffleArray(newPool);
            selectedQuestions = newPool.slice(0, QUESTIONS_PER_EXAM);
            modeTitle = "ç¬¬ä¸€éšæ®µï¼šæ¶ˆæ»…æœªåšé¡Œ";

        } else if (mode === 'review_wrong') {
            // é‚è¼¯ï¼šé¸ weight > 1 çš„
            let wrongPool = pool.filter(q => (data.weights[q.id] || 1) > 1);
            if (wrongPool.length === 0) {
                alert("å¤ªå¼·äº†ï¼ç›®å‰æ²’æœ‰ç´¯ç©çš„éŒ¯é¡Œã€‚\nè«‹å»æŒ‘æˆ°æ–°é¡Œæˆ–ç›´æ¥é€²è¡Œæ¨¡æ“¬è€ƒã€‚");
                return;
            }
            // éŒ¯é¡Œå„ªå…ˆåšæ¬Šé‡é«˜çš„
            wrongPool.sort((a, b) => (data.weights[b.id] || 1) - (data.weights[a.id] || 1));
            selectedQuestions = wrongPool.slice(0, QUESTIONS_PER_EXAM); // ä¹Ÿæ˜¯ä¸€æ¬¡åš40é¡Œä¸Šé™
            modeTitle = "ç¬¬äºŒéšæ®µï¼šéŒ¯é¡Œè¤‡ç¿’";

        } else if (mode === 'normal') {
            // é‚è¼¯ï¼šå…¨éš¨æ©Ÿ
            shuffleArray(pool);
            selectedQuestions = pool.slice(0, QUESTIONS_PER_EXAM);
            modeTitle = "ç¬¬ä¸‰éšæ®µï¼šå…¨çœŸæ¨¡æ“¬";
        }

        // åˆå§‹åŒ–æ¸¬é©—ç‹€æ…‹
        examQuestions = selectedQuestions;
        currentQuestionIndex = 0;
        correctCount = 0;
        userWrongAnswers = [];
        answerHistory = {};

        // UI åˆ‡æ›
        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('quiz-area').classList.remove('hidden');
        document.getElementById('current-mode-tag').innerText = modeTitle;
        document.getElementById('total-exam-q').innerText = examQuestions.length;

        renderQuestion();
    }

    // --- æ¸²æŸ“é¡Œç›® ---
    function renderQuestion() {
        const q = examQuestions[currentQuestionIndex];
        const container = document.getElementById('question-container');
        document.getElementById('current-q').innerText = currentQuestionIndex + 1;

        // æª¢æŸ¥æ­·å²ç‹€æ…‹
        const history = answerHistory[currentQuestionIndex];
        const isReviewed = (history && history.checked);

        // æº–å‚™é¸é …
        let optionsHtml = '';
        const keys = Object.keys(q.options).sort();
        const isInstant = (submitMode === 'instant' && q.type === 'radio' && !isReviewed);

        keys.forEach(key => {
            let checkedAttr = '';
            let disabledAttr = '';
            let clickAction = isInstant ? `onclick="checkAnswer()"` : '';

            // æ¢å¾©æ­·å²ç‹€æ…‹
            if (isReviewed) {
                if (history.userAns.includes(key)) checkedAttr = 'checked';
                disabledAttr = 'disabled';
                clickAction = ''; 
            }

            optionsHtml += `
                <label>
                    <input type="${q.type}" name="option" value="${key}" ${clickAction} ${checkedAttr} ${disabledAttr}>
                    <span style="font-weight:bold; margin-right:5px;">${key}.</span>
                    ${q.options[key]}
                </label>
            `;
        });

        // æ¨™è¨˜é€™é¡Œæ˜¯ä¸æ˜¯"æ–°é¡Œ" (ä¸åœ¨å·²åšæ¸…å–®ä¸­)
        const data = getStoredData();
        const isNew = !data.answeredIds.includes(q.id);
        const newBadge = isNew ? `<span class="tag-new">NEW</span>` : ``;

        container.innerHTML = `
            <div class="question-card">
                <div class="question-title">
                    ${newBadge} ${q.id}. ${q.text}
                </div>
                <div class="options">${optionsHtml}</div>
                <div id="result-msg" class="result-msg hidden"></div>
            </div>
        `;

        // æŒ‰éˆ•ç‹€æ…‹æ§åˆ¶
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const submitBtn = document.getElementById('submit-btn');

        currentQuestionIndex === 0 ? prevBtn.classList.add('hidden') : prevBtn.classList.remove('hidden');

        if (isReviewed) {
            showResultUI(history.isCorrect, q.answer);
            submitBtn.classList.add('hidden');
            
            if (currentQuestionIndex < examQuestions.length - 1) {
                nextBtn.classList.remove('hidden');
                nextBtn.innerText = "ä¸‹ä¸€é¡Œ â¡";
                nextBtn.onclick = nextQuestion;
            } else {
                nextBtn.classList.remove('hidden');
                nextBtn.innerText = "æŸ¥çœ‹æˆç¸¾ ğŸ";
                nextBtn.onclick = showFinalResult;
            }
        } else {
            // æœªä½œç­”
            isInstant ? submitBtn.classList.add('hidden') : submitBtn.classList.remove('hidden');
            nextBtn.classList.add('hidden');
        }
    }

    // --- æ ¸å¿ƒï¼šæª¢æŸ¥ç­”æ¡ˆèˆ‡è¨˜éŒ„ ---
    function checkAnswer() {
        const q = examQuestions[currentQuestionIndex];
        const selectedEls = document.querySelectorAll('input[name="option"]:checked');
        
        if (answerHistory[currentQuestionIndex]?.checked) return;

        let userAns = Array.from(selectedEls).map(el => el.value).sort();
        if (userAns.length === 0) {
            if(submitMode !== 'instant') alert("è«‹å…ˆé¸æ“‡ç­”æ¡ˆï¼");
            return;
        }

        const isCorrect = JSON.stringify(userAns) === JSON.stringify(q.answer);
        
        // 1. æ›´æ–°å…§å­˜ç‹€æ…‹
        if (isCorrect) correctCount++;
        answerHistory[currentQuestionIndex] = { userAns, isCorrect, checked: true };
        
        if (!isCorrect) {
            userWrongAnswers.push({ q, userAns });
        }

        // 2. å¯«å…¥æ°¸ä¹…è³‡æ–™åº« (LocalStorage)
        updatePersistentData(q.id, isCorrect);

        // 3. UI åæ˜ 
        showResultUI(isCorrect, q.answer);
        document.querySelectorAll('input[name="option"]').forEach(i => i.disabled = true);
        document.getElementById('submit-btn').classList.add('hidden');

        // 4. è‡ªå‹•è·³è½‰
        setTimeout(() => {
            if (currentQuestionIndex < examQuestions.length - 1) {
                nextQuestion();
            } else {
                showFinalResult();
            }
        }, 800);
    }

    function updatePersistentData(qId, isCorrect) {
        let data = getStoredData();
        
        // è¨˜éŒ„ "å·²åšé"
        let idSet = new Set(data.answeredIds);
        idSet.add(qId);
        data.answeredIds = Array.from(idSet);

        // æ›´æ–° "æ¬Šé‡"
        let w = data.weights[qId] || 1;
        if (isCorrect) {
            // ç­”å°äº†ï¼Œæ¬Šé‡æ¸›è¼•ï¼Œæœ€ä½ç‚º 1
            w = Math.max(1, w - 1); 
        } else {
            // ç­”éŒ¯äº†ï¼Œæ¬Šé‡å¢åŠ 
            w = w + 2; // éŒ¯ä¸€æ¬¡åŠ é‡ä¸€é»ï¼Œè®“å®ƒæ›´å®¹æ˜“åœ¨éŒ¯é¡Œè¤‡ç¿’å‡ºç¾
        }
        data.weights[qId] = w;

        saveData(data);
    }

    function showResultUI(isCorrect, ans) {
        const div = document.getElementById('result-msg');
        div.classList.remove('hidden');
        if (isCorrect) {
            div.innerHTML = "ğŸ‰ æ­£ç¢ºï¼";
            div.className = "result-msg correct";
        } else {
            div.innerHTML = `âŒ éŒ¯èª¤ï¼æ­£ç¢ºç­”æ¡ˆï¼š${ans.join('')}`;
            div.className = "result-msg wrong";
        }
    }

    // --- å°èˆª ---
    function prevQuestion() {
        if (currentQuestionIndex > 0) {
            currentQuestionIndex--;
            renderQuestion();
        }
    }
    
    function nextQuestion() {
        if (currentQuestionIndex < examQuestions.length - 1) {
            currentQuestionIndex++;
            renderQuestion();
        } else {
            showFinalResult();
        }
    }

    // --- çµç®— ---
    function showFinalResult() {
        document.getElementById('quiz-area').classList.add('hidden');
        document.getElementById('final-result').classList.remove('hidden');

        const score = correctCount * 2.5; // å‡è¨­æ¯é¡Œ2.5åˆ†
        document.getElementById('final-score').innerText = score;
        document.getElementById('correct-count').innerText = correctCount;
        document.getElementById('total-count').innerText = examQuestions.length;

        const list = document.getElementById('analysis-list');
        list.innerHTML = '';
        
        if (userWrongAnswers.length === 0) {
            list.innerHTML = '<div style="text-align:center; padding:20px; color:#28a745;">âœ¨ å¤ªæ£’äº†ï¼æœ¬æ¬¡æ¸¬é©—å…¨å°ï¼</div>';
        } else {
            userWrongAnswers.forEach((item, idx) => {
                list.innerHTML += `
                    <div class="analysis-item">
                        <div style="font-weight:bold; margin-bottom:5px;">${idx+1}. ${item.q.text}</div>
                        <div style="font-size:0.9em;">
                            ä½ çš„ç­”æ¡ˆ: <span style="color:#dc3545; font-weight:bold;">${item.userAns.join('')}</span> â” 
                            æ­£ç¢ºç­”æ¡ˆ: <span style="color:#198754; font-weight:bold;">${item.q.answer.join('')}</span>
                        </div>
                    </div>
                `;
            });
        }
    }

    function quitExam() {
        if(confirm("ç¢ºå®šè¦ä¸­æ–·æ¸¬é©—è¿”å›é¦–é å—ï¼Ÿ(é€²åº¦å·²ä¿å­˜)")) {
            goHome();
        }
    }

    function goHome() {
        document.getElementById('quiz-area').classList.add('hidden');
        document.getElementById('final-result').classList.add('hidden');
        document.getElementById('start-screen').classList.remove('hidden');
        updateDashboard();
    }

    function resetAllData() {
        if(confirm("âš ï¸ è­¦å‘Šï¼šé€™å°‡æœƒæ¸…é™¤æ‰€æœ‰ã€Œå·²åšé¡Œç›®ç´€éŒ„ã€èˆ‡ã€ŒéŒ¯é¡Œæ¬Šé‡ã€ã€‚\n\nç¢ºå®šè¦é‡æ–°é–‹å§‹å—ï¼Ÿ")) {
            localStorage.removeItem('tqc_smart_data');
            updateDashboard();
            alert("å·²é‡ç½®æ‰€æœ‰è³‡æ–™ï¼Œç¥æ‚¨é‡æ–°å‡ºç™¼é †åˆ©ï¼");
        }
    }

    // å·¥å…·: æ´—ç‰Œç®—æ³•
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }
</script>

</body>
</html>